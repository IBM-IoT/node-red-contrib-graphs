<script type="text/javascript">
  ( function() {

    var MyGraph = function( container , datasources , config , data ) {
      this.datasources = datasources;

      this.container = $( '<div style="flex:1"></div>' )[0];
      $( container ).append( this.container );

      this.config = config;
      this.config.history = parseInt( this.config.history );
      if( isNaN( this.config.history ) ) this.config.history = 1200000;
      this.limit = parseInt( this.config.dataLimit );
      if( !isNaN( this.limit ) )
      {
        if( this.limit < 10 ) this.limit = 10;
        this.limit *= datasources.length;
      }
      else this.limit = null;

      this.data = [];
      this.graph = null;

      if( data && data.length > 0 )
      {
        this.pushData( data );
      }

      var now = ( new Date() ).getTime();
      for( var i = 0; i < this.datasources.length; i++ )
      {
        this.datasources[i].datasource.requestHistoryData( i , now - this.config.history , now - 2000 , this.addHistoryData.bind( this ) );
      }

      $( container ).parents( "li" ).on( "resize" , this._resize.bind( this ) );
    };

    MyGraph.prototype._resize = function() {
      if( this.graph )
      {
        // HACK: Container height must be reset, otherwise it won't shrink properly
        $( this.container ).css( "height" , "0" );
        this.graph.resize();
      }
    };

    MyGraph.prototype._newData = function() {
      if( !this.data.length ) return;

      if( this.limit !== null && this.data.length > this.limit )
      {
        this.data.splice( 0 , this.data.length - this.limit );
      }

      if( this.graph === null )
      {
        var graphLabels = [ "Time" ],
            i;

        var options = {
          connectSeparatedPoints : true,
          drawPoints : false,
          showRoller : true,
          xlabel : this.config.xLabel,
          ylabel : this.config.yLabel,
          axisLabelColor : "#8d9194",
          axisLineColor : "#8d9194",
          gridLineColor : "#4d4e4f",
          showRangeSelector : ( this.datasources.length === 1 ),
          rangeSelectorPlotFillColor : "",
          rangeSelectorPlotStrokeColor : "#c67a08",
          labelsDivStyles : {
            background : "rgba( 0 , 0 , 0 , 0.2 )",
            color : "#EEE",
            padding : "5px"
          },
          legend : "always",
          colorValue : 0.7,
          colorSaturation : 0.6
        };

        options.labels = [ "Time" ];
        for( i = 0; i < this.datasources.length; i++ )
        {
          var label = this.datasources[i].config.label;
          options.labels.push( label );
          options[ label ] = {
            fillGraph : this.datasources[i].config.area
          };
        }

        $( this.container ).empty();
        this.graph = new Dygraph( this.container , this.data , options );

        $( this.container ).find( 'input[type="text"]' ).addClass( "form-control" ).css( "width" , "50px" ).css( "height" , "25px" );
      }
      else
      {
        this.graph.updateOptions( { file : this.data } );
      }
    };

    MyGraph.prototype.pushData = function( index , data ) {
      if( index < 0 || index >= this.datasources.length ) return;

      var lastElem = this.data.length > 0 ? this.data[ this.data.length - 1 ] : null;
      if( lastElem === null || lastElem[0].getTime() < data.tstamp )
      {
        this.data.push( this.createNewDatapoint( data.tstamp , index , data.data ) );
      }
      else
      {
        if( lastElem[0].getTime() === data.tstamp ) lastElem[ index + 1 ] = data.data;
        else return;
      }

      this._newData();
    };

    MyGraph.prototype.addHistoryData = function( index , data ) {
      var i,k;

      if( this.data.length < 1 || data[ data.length - 1 ].tstamp < this.data[0][0].getTime() )
      {
        for( i = data.length - 1; i >= 0; i-- )
        {
          this.data.unshift( this.createNewDatapoint( data[i].tstamp , index , data[i].data ) );
        }
      }
      else
      {
        data = data.slice( 0 );
        i = this.findData( data[ data.length - 1 ][0] );
        while( i >= 0 && data.length > 0 )
        {
          if( data[ data.length - 1 ].tstamp < this.data[i][0].getTime() )
          {
            i--;
            continue;
          }

          var newData = data.pop();
          if( this.data[i][0].getTime() == newData.tstamp )
          {
            this.data[i][ index + 1 ] = newData.data;
          }
          else
          {
            this.data.splice( i + 1 , 0 , this.createNewDatapoint( newData.tstamp , index , newData.data ) );
          }
        }

        if( data.length > 0 )
        {
          this.addHistoryData( index , data );
          return;
        }
      }

      this._newData();
    };

    MyGraph.prototype.findData = function( timestamp )
    {
      var min = 0, max = this.data.length - 1, mid = 0;

      while( max >= min )
      {
        mid = Math.floor( ( min + max ) / 2 );
        if( this.data[ mid ][0].getTime() == timestamp ) return mid;
        else if( this.data[ mid ][0].getTime() > timestamp ) max = mid - 1;
        else min = mid + 1;
      }

      return this.data[ mid ][0].getTime() < timestamp ? mid : mid - 1;
    };

    MyGraph.prototype.createNewDatapoint = function( timestamp , index , data )
    {
      var newData = [ new Date( timestamp ) ];
      for( var i = 0; i < this.datasources.length; i++ )
      {
        newData.push( i === index ? data : null );
      }

      return newData;
    };

    App.Plugins.registerChartType( "dygraph" , MyGraph , {
      dependencies : [
        "https://cdnjs.cloudflare.com/ajax/libs/dygraph/1.1.1/dygraph-combined.js"
      ],
      display_name : "DyGraph",
      chartConfig : {
        xLabel : { default : "" },
        yLabel : { default : "" },
        dataLimit : { default : "" }
      },
      datasourceConfig : {
        area : { default : false }
      }
    } );

  } )();
</script>

<script type="text/x-dash" data-chart-config="dygraph">
  <div class="form-group">
    <label for="c-xLabel">X Axis Label</label>
    <input class="form-control" type="text" id="c-xLabel" data-prop="xLabel">
  </div>
  <div class="form-group">
    <label for="c-yLabel">Y Axis Label</label>
    <input class="form-control" type="text" id="c-yLabel" data-prop="yLabel">
  </div>
  <div class="form-group">
    <label for="c-dataLimit">Data Limit (leave blank for no limit)</label>
    <input class="form-control" type="text" id="c-dataLimit" data-prop="dataLimit">
  </div>
</script>

<script type="text/x-dash" data-datasource-config="dygraph">
  <div class="form-group">
    <input type="checkbox" data-prop="area"> Fill area under graph
  </div>
</script>
